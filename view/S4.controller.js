/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("sap.ca.ui.quickoverview.EmployeeLaunch");jQuery.sap.require("ui.s2p.mm.purchorder.approve.util.Conversions");sap.ca.scfld.md.controller.BaseDetailController.extend("ui.s2p.mm.purchorder.approve.view.S4",{sOrigin:"",sWorkitemID:"",sPoNumber:"",sItemNumber:"",onInit:function(){this.getView().getModel().setSizeLimit(1000000);if(!this.oApplication){this.oApplication=sap.ca.scfld.md.app.Application.getImpl();this.oConfiguration=this.oApplication.oConfiguration;this.oConnectionManager=this.oApplication.getConnectionManager();this.resourceBundle=this.oApplication.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel()}this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="itemDetails"){this.sOrigin=e.getParameter("arguments").SAP__Origin;this.sWorkitemID=e.getParameter("arguments").WorkitemID;this.sPoNumber=e.getParameter("arguments").PoNumber;this.sItemNumber=e.getParameter("arguments").ItemNumber;var i="/WorkflowTaskCollection(SAP__Origin='"+this.sOrigin+"',WorkitemID='"+this.sWorkitemID+"')"+"/HeaderDetails/ItemDetails(SAP__Origin='"+this.sOrigin+"',PoNumber='"+this.sPoNumber+"',ItemNumber='"+this.sItemNumber+"')";var I="/ItemDetailCollection(SAP__Origin='"+this.sOrigin+"',ItemNumber='"+this.sItemNumber+"',PoNumber='"+this.sPoNumber+"')";var o=this.oDataModel.getProperty(I);var s="";if(o){s=o.ItemCategory}var S=this.byId("SubcontractingTable");if(s==="3"){this.getView().bindElement(i,{expand:'Accountings,Notes,PricingConditions,Attachments,ServiceLines/Accountings,Limits/Accountings,Components'});this.getView().getElementBinding().attachEventOnce("dataReceived",function(){var c=[new sap.m.ObjectIdentifier({title:"{parts:[{path : 'Description'}, {path : 'Material'}], formatter : 'ui.s2p.mm.purchorder.approve.util.Conversions.IDFormatter'}"}),new sap.m.ObjectNumber({number:"{parts: [{path : 'Quantity'}], formatter : 'ui.s2p.mm.purchorder.approve.util.Conversions.formatQuantityWithoutUnit'}",numberUnit:"{BaseUnitDescription}"})];var t=new sap.m.ColumnListItem({cells:c});S.bindItems("Components",t,null,null);S.setVisible(true)},this)}else{this.getView().bindElement(i,{expand:'Accountings,Notes,PricingConditions,Attachments,ServiceLines/Accountings,Limits/Accountings'});S.setVisible(false)}this.setLocalHeaderFooterOptions()}},this);if(this.extHookOnInit){this.extHookOnInit()}},setLocalHeaderFooterOptions:function(){var t=this;var h=this._headerDetailCollection(this.sOrigin,this.sPoNumber);var i=this._itemDetailCollection(this.sOrigin,this.sItemNumber,this.sPoNumber);var I=this.oDataModel.getProperty("/"+h+"/ItemDetails");if(typeof I==="undefined"){this.navBack();return}var l=I.length;var c=I.indexOf(i);var L={onBack:function(){t.navBack()},oUpDownOptions:{iPosition:c,iCount:l,fSetPosition:function(n){var p=I[n];var s=t.oDataModel.getProperty("/"+p).ItemNumber;t.oRouter.navTo("itemDetails",{SAP__Origin:t.sOrigin,WorkitemID:t.sWorkitemID,PoNumber:t.sPoNumber,ItemNumber:s},true)},sI18NDetailTitle:"view.ItemDetails.title"}};if(this.extHookSetHeaderFooterOptions){L=this.extHookSetHeaderFooterOptions(L)}this.setHeaderFooterOptions(L)},navBack:function(){if(this.sOrigin!==""&&this.sWorkitemID!==""){var m="WorkflowTaskCollection(SAP__Origin='"+this.sOrigin+"',WorkitemID='"+this.sWorkitemID+"')";this.oRouter.navTo("detail",{contextPath:m},true)}},_refresh:function(c,e,d){},onServiceItemPress:function(e){var b=e.getSource().getBindingContext().getPath();var m=this.getView().getModel();this.oRouter.navTo("itemServiceLine",{SAP__Origin:this.getView().getBindingContext().getProperty("SAP__Origin"),WorkitemID:this.sWorkitemID,PoNumber:this.getView().getBindingContext().getProperty("PoNumber"),ItemNumber:this.getView().getBindingContext().getProperty("ItemNumber"),ServiceLineNumber:m.getProperty(b).ServiceLineNumber},true)},onServiceLimitPress:function(e){var b=e.getSource().getBindingContext().getPath();var m=this.getView().getModel();this.oRouter.navTo("itemServiceLimit",{SAP__Origin:this.getView().getBindingContext().getProperty("SAP__Origin"),WorkitemID:this.sWorkitemID,PoNumber:this.getView().getBindingContext().getProperty("PoNumber"),ItemNumber:this.getView().getBindingContext().getProperty("ItemNumber"),LimitDescription:m.getProperty(b).LimitDescription},true)},_headerDetailCollection:function(o,p){var r="HeaderDetailCollection(SAP__Origin='"+o+"',PoNumber='"+p+"')";return r},_itemDetailCollection:function(o,i,p){var r="ItemDetailCollection(SAP__Origin='"+o+"',ItemNumber='"+i+"',PoNumber='"+p+"')";return r},onAttachment:function(e){ui.s2p.mm.purchorder.approve.util.Conversions.onAttachment(e)},onSenderPress:function(e){this.openEmployeeLaunch(e,"CreatedByID")},openEmployeeLaunch:function(e,r){var c=e.getSource();var t=this.resourceBundle.getText("BussinessCard.Employee");var o=function(d){var a=d.results[0],E={title:t,name:a.FullName,imgurl:ui.s2p.mm.purchorder.approve.util.Conversions.businessCardImg(a.Mime_Type,a.__metadata.media_src),department:a.Department,contactmobile:a.MobilePhone,contactphone:a.WorkPhone,contactemail:a.EMail,companyname:a.CompanyName,companyaddress:a.AddressString},b=new sap.ca.ui.quickoverview.EmployeeLaunch(E);b.openBy(c)};var O=e.getSource().getBindingContext().getProperty("SAP__Origin");var u=e.getSource().getBindingContext().getProperty(r);this.oDataModel=this.oConnectionManager.modelList[this.oConfiguration.getServiceList()[0].name];var f="$filter="+encodeURIComponent("=UserID eq '"+u+"' and SAP__Origin eq '"+O+"'");this.oDataModel.read("UserDetailsCollection",null,[f],true,jQuery.proxy(o,this),jQuery.proxy(this._onRequestFailed,this))},_onRequestFailed:function(e){var m="";var d=null;if(e.response&&e.response.body!=""&&(e.response.statusCode=="400"||e.response.statusCode=="500")){var M=JSON.parse(e.response.body);m=M.error.message.value}if(m==""){m=e.message;d=e.response.body}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:m,details:d})}});
